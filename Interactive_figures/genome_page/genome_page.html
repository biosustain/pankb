<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Genome page</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/navbar-fixed/">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.js"> </script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"> </script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"> </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">


    <style>

        .table_padding{
            padding-top:0px;
            padding-bottom:0px;
            padding-right:1em;
            padding-left:1em;
        }

        th, td{
            height:2.8em;
            font-size: 0.9em;
            padding-left: 1em !important;
            padding-right: 1em !important;
        }

        .dataTables_wrapper thead th {
            text-align: center;
            vertical-align: middle;
            padding: 1em;
            position: relative;
        }

        .dataTables_wrapper thead th input {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            margin-bottom: 0.45em;
        }

        .dataTables_wrapper tbody td {
            text-align: center;
            vertical-align: middle;
            padding: 0.45em;
            word-break: break-word;
        }


        .responsive-iframe iframe {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 10%;
            right: 0;
            width: 100%;
            height: 100%;
        }

        #genome_page_title {
            margin-top: 2em;
        }


        .navbar-nav .nav-item .nav-link {
            margin-left: 1em;
            margin-right: 1em;
            font-size: 1em;
        }


        .logo-image_navbar {
            height: 3vh;
        }

        html {
            font-size: 18px;
        }


    </style>
</head>
<body>

<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="../../index.html" style="margin: 0;">
            <img src="../../pankb_logo.svg" alt="PanKB" class="d-inline-block align-text-top logo-image_navbar">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-center" id="navbarCollapse">
            <ul class="navbar-nav mb-2 mb-md-0">
                <li class="nav-item">
                    <a class="nav-link " aria-current="page" href="../../About.html">About</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link " href="../../Species_list.html">Organisms</a>
                </li>
<!--                <li class="nav-item">-->
<!--                    <a class="nav-link " href="#">Download</a>-->
<!--                </li>-->
                <li class="nav-item">
                    <a class="nav-link " href="../../Publications.html" tabindex="-1" aria-disabled="true">Publications</a>
                </li>
            </ul>
        </div>
        <a class="navbar-brand" href="../../index.html" style="margin: 0; visibility: hidden; ">
            <img src="../../pankb_logo.svg" alt="PanKB" class="d-inline-block align-text-top logo-image_navbar">
        </a>
    </div>
</nav>

<br>
<h2 id = 'genome_page_title' style = 'text-align: center; font-size: 1.6em;'>Genome & Gene Info Page</h2>

<div class="row">
    <div class="col-1">
    </div>

    <div class="col-10">
        <br>
        <br>

        <div class="table_padding">
            <table id="genome_info" class="table table-hover" style="width:100%; table-layout: fixed;">
                <thead>
                <tr>
                    <th class="text-center align-middle">Genome ID</th>
                    <th class="text-center align-middle">Species (NCBI)</th>
                    <th class="text-center align-middle">Source</th>
                    <th class="text-center align-middle">Isolation Source</th>
                    <th class="text-center align-middle">Country</th>
                    <th class="text-center align-middle">Geological Location Name</th>
                    <th class="text-center align-middle">GC Content</th>
                    <th class="text-center align-middle">Genome Length</th>
                    <th class="text-center align-middle">Number of Genes</th>
                    <th class="text-center align-middle">Gene Class Distribution</th>
                </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>


        <div class="table_padding">
            <table id="gene_info" class="table table-hover" style="width:100%; table-layout: fixed;">
                <thead>
                <tr>
                    <th class="text-center align-middle">Gene ID</th>
                    <th class="text-center align-middle">Gene Class</th>
                    <th class="text-center align-middle">Locus Tag</th>
                    <th class="text-center align-middle">Prokka Annotation</th>
                    <th class="text-center align-middle">Start Position</th>
                    <th class="text-center align-middle">End Position</th>
                    <th class="text-center align-middle">Nucleotide Seq</th>
                    <th class="text-center align-middle">Amino Acid Seq</th>
                </tr>
                </thead>

                <tbody class="text-center align-middle" id="tbody">

                </tbody>
            </table>
        </div>


        <br>
        <br>

        <div class="d-flex justify-content-center align-items-center" style="height: 50vh;">
            <iframe id="Genome_page_COG_distribution" class="w-100 h-100" style="border:0;"></iframe>
        </div>

        <br>
        <br>

<!--        <div class="d-flex justify-content-center align-items-center" style="height: 60vh;">-->
<!--            <iframe id="antismash" class="w-100 h-100" style="border:0;"></iframe>-->
<!--        </div>-->
    </div>

    <div class="col-1">
    </div>

</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const species = urlParams.get('species');
    const genome_id = urlParams.get('genome_id');
    const gene_class = urlParams.get('gene_class');
    let gene_id = urlParams.get('gene_id');
    if (gene_id.includes('/')) {
        gene_id = gene_id.replace(/\//g, '_');
    }

    // Load the JSON file
    fetch('https://pankb.blob.core.windows.net/data/PanKB/web_data/species/' + species + '/genome_page/' + genome_id + '/genome_info.json')
        .then(response => response.json())
        .then(data => {
            const tableBody = document.getElementById('table-body');

            const geneClassDistribution = data[genome_id]['Gene_class_distribution'];

            const total = geneClassDistribution[0] + geneClassDistribution[1] + geneClassDistribution[2];
            const coreWidth = (geneClassDistribution[0] / total) * 100;
            const accessoryWidth = (geneClassDistribution[1] / total) * 100;
            const rareWidth = (geneClassDistribution[2] / total) * 100;
            const number_of_genes = geneClassDistribution.reduce((a, b) => a + b, 0);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="text-center align-middle">${genome_id}</td>
                <td class="text-center align-middle">${data[genome_id]['full_name']}</td>
                <td class="text-center align-middle"><a href="https://www.ncbi.nlm.nih.gov/datasets/genome/${genome_id}" target="_blank">NCBI</a></td>
                <td class="text-center align-middle">${data[genome_id]['isolation_source']}</td>
                <td class="text-center align-middle">${data[genome_id]['Country']}</td>
                <td class="text-center align-middle">${data[genome_id]['geo_loc_name']}</td>
                <td class="text-center align-middle">${(data[genome_id] && typeof data[genome_id]['gc_content'] === 'number') ? data[genome_id]['gc_content'].toFixed(3) : 'null'}</td>
                <td class="text-center align-middle">${data[genome_id]['genome_len']}</td>
                <td class="text-center align-middle">${number_of_genes}</td>
                <td class="text-center align-middle">
                    <div style="display: flex; height: 20px; max-width: 80%; margin: auto; border-radius: 10px; overflow: hidden;">
                        <div style="width: ${coreWidth}%; background-color: rgba(128,0,128,0.8);" data-toggle="tooltip" title="Core: ${geneClassDistribution[0]}"></div>
                        <div style="width: ${accessoryWidth}%; background-color: rgba(255,165,0,0.8);" data-toggle="tooltip" title="Accessory: ${geneClassDistribution[1]}"></div>
                        <div style="width: ${rareWidth}%; background-color: rgba(0,128,0,0.8);" data-toggle="tooltip" title="Rare: ${geneClassDistribution[2]}"></div>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);

            // Initialize tooltips
            $(function () {
                $('[data-toggle="tooltip"]').tooltip()
            })
            // Initialize DataTable
            $('#species_list').DataTable();
        })
        .catch(error => console.error(error));

    document.addEventListener('DOMContentLoaded', async function() {
        try {
            const data = await $.ajax({
                'url': 'https://pankb.blob.core.windows.net/data/PanKB/web_data/species/'+ species + '/gene_locustag/' + gene_id + '.json',
                'dataType': 'json'
            });

            console.log('https://pankb.blob.core.windows.net/data/PanKB/web_data/species/'+ species + '/gene_locustag/' + gene_id + '.json')

            var geneData = data; // Convert the data object to an array for DataTables

            // Filter the geneData based on the Genome ID
            const matchedEntry = geneData.find(entry => entry.Genome_ID === genome_id);
            geneData = matchedEntry ? [matchedEntry] : [];

            let emptyTableText = 'Loading...';

            if (geneData.length === 0) {
                emptyTableText = 'Gene ' + '<b>' +  gene_id  + '</b>' + ' doesn\'t exist in genome ' + '<b>' +  genome_id  + '</b>' ;
            }

            let table = $('#gene_info').DataTable({
                data: geneData,
                columns: [
                    {
                        data: null,
                        render: function(data, type, row) {
                            return '<a href="../../Gene_function/locustag.html?species=' + species + '&gene=' + encodeURIComponent(gene_id) + '&gene_class=' + encodeURIComponent(gene_class) +'" target="_blank">' + gene_id + '</a>';
                        }
                    },
                    {
                        data: null,
                        render: function(data, type, row) {
                            return gene_class;
                        },
                    },
                    { data: 'Locus_Tag' },
                    { data: 'Prokka_Annotation' },
                    { data: 'Start_Position' },
                    { data: 'End_Position' },
                    { data: 'Nucleotide_Seq' },
                    { data: 'Amino_Acid_Seq' }
                ],
                columnDefs: [
                    {
                        targets: [6, 7], // Apply the function to the inference, translation, and product columns
                        render: function(data, type, row) {
                            if (type === 'display' && data.length > 20) {
                                return '<span class="truncated" data-toggle="tooltip" data-fulltext="' + data + '" title="' + data + '">' + data.substr(0, 20) + '...</span>';
                            } else {
                                return data;
                            }
                        }
                    }
                ],
                dom: 'Bfrtip', // Remove the toolbar
                info: false, // Remove the entry info
                paging: false, // Remove the page counter
                searching: false, // Remove the search bar
                language: {
                    emptyTable: emptyTableText
                },
                order: [],
                bSort: true
            });

        } catch (error) {
            console.error('Error:', error);
        }

        $('body').on('click', '.truncated', function() {
            var fullText = $(this).attr('data-fulltext');
            var truncatedText = $(this).text();
            var cell = $(this).closest('td');

            if (fullText !== truncatedText) { // check if fullText is not equal to truncatedText
                $(this).text(fullText);
                cell.addClass('expanded');
            } else {
                $(this).text(fullText.substr(0, 20) + '...');
                cell.removeClass('expanded');
            }

            table.draw(false); // Redraw the DataTable to readjust the layout
        });
    });


    const Genome_page_COG_distribution = document.getElementById('Genome_page_COG_distribution');
    Genome_page_COG_distribution.src = './barplot.html?species=' + encodeURIComponent(species) + '&' + 'genome_id=' + encodeURIComponent(genome_id) ;

    const antismash = document.getElementById('antismash');
    antismash.src = 'https://pankb.blob.core.windows.net/data/PanKB/web_data/species/' + encodeURIComponent(species) + '/antismash/' + encodeURIComponent(genome_id) + '/index.html';

    // document.getElementById('genome_page_title').innerHTML= 'Genome & Gene Info Page' + '<br>' +
    //     '<b>' +  gene_id  + '</b>' + ' in ' + '<b>'  + genome_id + '</b>';

</script>

<script>
    function adjustHtmlFontSize(coefficient) {
        const newFontSize = 18 * coefficient;
        document.documentElement.style.fontSize = newFontSize + 'px';
    }


    // Function to adjust all styles
    function adjustStyles() {
        const template_screen_width = 1920;
        const current_window_Width = window.innerWidth;
        const coefficient = current_window_Width / template_screen_width;

        adjustHtmlFontSize(coefficient);
    }

    // Adjust styles on page load and window resize
    document.addEventListener("DOMContentLoaded", adjustStyles);
    window.addEventListener("resize", adjustStyles);
</script>

</body>
</html>
